<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Miss & Mister Arts et Humanit√©s Num√©riques 2026 ‚Äî Vote PAYANT</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
/* Styles existants... */
.candidate-number {
    position: absolute;
    top: 10px;
    left: 10px;
    background: var(--accent-1);
    color: white;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 1.1rem;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    z-index: 10;
}

.candidate-info h3 {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    gap: 5px;
    margin-bottom: 8px;
}

.candidate-info .number-badge {
    background: var(--accent-1);
    color: white;
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 0.9rem;
    font-weight: bold;
    display: inline-block;
}

.admin-transaction-info {
    font-size: 0.9rem;
    margin-top: 8px;
    color: #666;
    background: #f8f9fa;
    padding: 8px;
    border-radius: 8px;
}

.admin-transaction-info span {
    font-weight: bold;
    color: var(--accent-2);
}

.ranking-rank {
    display: inline-block;
    width: 32px;
    height: 32px;
    background: var(--accent-1);
    color: white;
    border-radius: 50%;
    text-align: center;
    line-height: 32px;
    margin-right: 10px;
    font-weight: bold;
    font-size: 1rem;
}

.ranking-rank.rank-1 {
    background: #ffd700; /* Or */
    color: #000;
}

.ranking-rank.rank-2 {
    background: #c0c0c0; /* Argent */
    color: #000;
}

.ranking-rank.rank-3 {
    background: #cd7f32; /* Bronze */
    color: #000;
}

.ranking-info {
    display: flex;
    align-items: center;
    margin-bottom: 5px;
}

.ranking-candidate-number {
    background: var(--accent-2);
    color: white;
    padding: 3px 8px;
    border-radius: 8px;
    font-size: 0.8rem;
    margin-right: 8px;
    font-weight: bold;
}

.ranking-bar-container {
    width: 100%;
    height: 14px;
    background: #e9ecef;
    border-radius: 8px;
    overflow: hidden;
    margin-top: 5px;
}

.ranking-bar {
    height: 100%;
    background: var(--accent-2);
    border-radius: 8px;
    transition: width 1s;
}

/* Styles existants restent inchang√©s... */
:root{
  --bg:#f4f7fb;
  --card:#ffffff;
  --muted:#6b7280;
  --accent-1:#ff7a00;
  --accent-2:#3b6bf0;
  --accent-3:#ff3c78;
  --glass:rgba(255,255,255,0.85);
  --shadow:rgba(0,0,0,0.12);
}
*{box-sizing:border-box;margin:0;padding:0;font-family:'Inter',sans-serif;}
body{background:var(--bg);color:#0f172a;}
.page{max-width:1200px;margin:0 auto;padding:20px;}
header.hero{
  position:relative;
  border-radius:24px;
  padding:60px 20px;
  text-align:center;
  color:white;
  background:linear-gradient(135deg,var(--accent-1),var(--accent-2),var(--accent-3),var(--accent-1));
  background-size:400% 400%;
  animation:gradientBG 15s ease infinite;
  box-shadow:0 12px 40px rgba(0,0,0,0.2);
}
@keyframes gradientBG{
  0%{background-position:0% 50%}
  50%{background-position:100% 50%}
  100%{background-position:0% 50%}
}
.hero h1{font-size:3rem;margin-bottom:12px;text-shadow:0 3px 12px rgba(0,0,0,0.25);}
.hero .subtitle{font-size:1.3rem;color:rgba(255,255,255,0.9);margin-bottom:20px;}
.hero .meta{display:flex;justify-content:center;gap:40px;font-weight:700;font-size:1.1rem;}
.admin-btn{
  position:absolute;top:20px;right:20px;
  background:rgba(255,255,255,0.25);
  backdrop-filter:blur(6px);
  border:none;color:white;
  padding:12px 20px;
  border-radius:14px;
  font-weight:700;cursor:pointer;
  transition:0.3s;
}
.admin-btn:hover{background:rgba(255,255,255,0.4);transform:scale(1.05);}
.grid{display:grid;grid-template-columns:1fr;gap:24px;margin-top:40px;}
.card{background:var(--card);border-radius:20px;padding:32px;box-shadow:0 12px 36px var(--shadow);}
.candidates{display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:24px;}
.candidate{
  background:#fff;border-radius:20px;overflow:hidden;
  box-shadow:0 8px 20px var(--shadow);
  display:flex;flex-direction:column;
  transition:transform 0.4s,box-shadow 0.4s;
  position: relative;
}
.candidate:hover{transform:translateY(-12px);box-shadow:0 20px 40px var(--shadow);}
.thumb{width:100%;height:240px;background:#eef6ff;display:flex;align-items:center;justify-content:center;overflow:hidden;}
.thumb img{width:100%;height:100%;object-fit:cover;transition:transform 0.4s;}
.candidate:hover .thumb img{transform:scale(1.07);}
.info{padding:20px;flex:1;display:flex;flex-direction:column;justify-content:space-between;}
.info h3{font-size:1.2rem;margin-bottom:8px;}
.votes-badge{
  margin-top:6px;font-weight:700;color:var(--accent-2);
  transition:transform 0.3s,color 0.3s;
}
.votes-badge.animate{transform:scale(1.3);color:var(--accent-3);}
.actions{display:flex;justify-content:flex-end;margin-top:16px;}
.vote-btn{
  padding:12px 18px;
  background:linear-gradient(90deg,var(--accent-1),var(--accent-3));
  border:none;color:white;font-weight:700;border-radius:14px;cursor:pointer;transition:all 0.3s;
}
.vote-btn:hover{transform:scale(1.05);box-shadow:0 8px 16px rgba(0,0,0,0.2);}
#ranking{margin-top:32px;}
.ranking-item{
  margin-bottom:16px;
  transition:all 0.5s;
  position:relative;
  padding:12px;
  background: #fff;
  border-radius: 12px;
  box-shadow: 0 4px 12px var(--shadow);
}
#payment-modal,#admin-panel{
  position:fixed;top:0;left:0;width:100%;height:100%;
  background:rgba(0,0,0,0.55);display:none;
  align-items:center;justify-content:center;z-index:9999;animation:fadeIn 0.3s;
}
@keyframes fadeIn{0%{opacity:0}100%{opacity:1}}
.modal-content{
  background:white;width:450px;padding:32px;border-radius:20px;
  box-shadow:0 20px 40px rgba(0,0,0,0.25);
}
.modal-content h3{margin-bottom:18px;color:var(--accent-2);}
.modal-content label{margin-top:12px;display:block;font-weight:600;}
.modal-content input, .modal-content select{
  width:100%;padding:12px;border-radius:10px;border:1px solid #ccc;margin-bottom:10px;
}
.modal-content button{
  padding:12px 18px;width:100%;border-radius:14px;border:none;
  background:var(--accent-2);color:white;font-weight:700;cursor:pointer;transition:all 0.3s;margin-top:10px;
}
.modal-content button:hover{transform:scale(1.05);}
.admin-section{margin-top:20px;max-height:450px;overflow-y:auto;}
.admin-card{
  margin-bottom:14px;padding:12px;border:1px solid #eee;border-radius:12px;
  display:flex;justify-content:space-between;align-items:center;transition:all 0.3s;
}
.admin-card button{padding:8px 14px;border:none;background:var(--accent-2);color:white;border-radius:10px;cursor:pointer;margin-left:8px;transition:0.3s;}
.admin-card button.reject{background:#ff3c3c;}
.admin-card input{width:80px;padding:6px;border-radius:6px;border:1px solid #ccc;}
#payment-number{margin-bottom:10px;font-weight:600;}
footer{text-align:center;margin-top:40px;color:var(--muted);}
.loading{text-align:center;padding:40px;color:var(--muted);}
.loading-spinner{
  border:4px solid #f3f3f3;border-top:4px solid var(--accent-2);border-radius:50%;
  width:40px;height:40px;animation:spin 1s linear infinite;margin:0 auto 20px;
}
@keyframes spin{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}
.status-badge{
  position:fixed;top:10px;right:10px;z-index:1000;
  padding:8px 16px;border-radius:20px;font-size:0.9rem;font-weight:600;
  background:#d4edda;color:#155724;border:1px solid #c3e6cb;
}
.status-badge.offline{background:#f8d7da;color:#721c24;border:1px solid #f5c6cb;}
.status-badge.connecting{background:#fff3cd;color:#856404;border:1px solid #ffeaa7;}
.warning-box{
  background:#fff3cd;color:#856404;border:1px solid #ffeaa7;
  padding:15px;border-radius:10px;margin:15px 0;text-align:center;
}
.default-avatar{
  width:100px;height:100px;border-radius:50%;background:#3b6bf0;
  display:flex;align-items:center;justify-content:center;color:white;font-size:3rem;
  margin:0 auto;
}
@media(max-width:900px){.grid{grid-template-columns:1fr;}.candidates{grid-template-columns:1fr;}}
</style>
</head>
<body>
<div id="status-badge" class="status-badge connecting">‚è≥ Connexion...</div>

<div class="page">
<header class="hero">
<h1>Miss & Mister AHN 2025</h1>
<div class="subtitle">Votez pour vos candidats pr√©f√©r√©s !</div>
<div class="meta">
<div> <strong id="candidates-count">0</strong> Candidats</div>
<div> <strong id="votes-count">0</strong> Votes</div>
</div>
<button class="admin-btn"> Admin</button>
</header>

<div id="connection-warning" class="warning-box" style="display:none;">
‚ö†Ô∏è <strong>Mode local activ√©</strong> - La base de donn√©es n'est pas disponible. Les votes sont enregistr√©s localement.
</div>

<div class="grid">
<main>
<div class="card">
<h2 style="color:var(--accent-2);margin-bottom:12px;">Candidates Miss Master</h2>
<div class="candidates" id="miss-list">
  <div class="loading">
    <div class="loading-spinner"></div>
    Chargement des candidates...
  </div>
</div>
<h2 style="color:var(--accent-2);margin-top:32px;margin-bottom:12px;">Candidates Mister Master</h2>
<div class="candidates" id="mister-list">
  <div class="loading">
    <div class="loading-spinner"></div>
    Chargement des candidats...
  </div>
</div>
<h2 style="color:var(--accent-3);margin-top:32px;">Classement</h2>
<div id="ranking">
  <div class="loading">
    <div class="loading-spinner"></div>
    Chargement du classement...
  </div>
</div>
</div>
</main>
</div>
<footer>¬© Comit√© de Parrainage Arts et Humanit√©s Num√©riques 2030 ‚Äî Votes valid√©s par l'admin uniquement.</footer>
</div>

<!-- Payment Modal -->
<div id="payment-modal">
<div class="modal-content">
<h3>Paiement pour le vote</h3>
<label>Nombre de votes :</label>
<input type="number" id="vote-count" min="1" value="1">
<label>Montant √† payer :</label>
<input type="text" id="payment-amount" value="100 FCFA" readonly>
<label>Moyen de paiement :</label>
<select id="payment-method">
<option value="orange_money">Orange Money</option>
<option value="mtn_money">MTN Money</option>
<option value="wave">Wave</option>
</select>
<div id="payment-number">Num√©ro Orange Money : #150*46*0761200#</div>
<label>Code transaction :</label>
<input type="text" id="payment-code" placeholder="Entrez le code re√ßu par SMS">
<button id="submit-payment">Envoyer pour validation</button>
<button style="background:#eee;color:#333;" onclick="closePaymentModal()">Annuler</button>
</div>
</div>

<!-- Admin Panel -->
<div id="admin-panel">
<div class="modal-content">
<h2 style="color:var(--accent-2);">Panneau Admin</h2>
<label>Mot de passe :</label>
<input type="password" id="admin-pass">
<button id="admin-login">Se connecter</button>
<div id="admin-content" style="display:none;">
<h3 style="margin-top:20px;">Transactions en attente</h3>
<div class="admin-section" id="pending-list-section">
  <div class="loading">
    Chargement des transactions...
  </div>
</div>
</div>
<button onclick="closeAdminPanel()" style="margin-top:20px;">Fermer</button>
</div>
</div>

<script>
// ============================
// CONFIGURATION
// ============================

// URL de l'API Flask
const API_BASE_URL = window.location.hostname === 'localhost' 
  ? 'http://localhost:5000/api' 
  : 'http://' + window.location.hostname + ':5000/api';

// Dossier o√π sont stock√©es les images
const IMAGES_BASE_PATH = '/Photo/';

// Prix par vote
const PRICE_PER_VOTE = 100;

// Variables globales
let allCandidates = [];
let pendingTransactions = [];
let currentCandidateId = null;
let isDatabaseConnected = false;
let adminToken = null;

// ============================
// FONCTIONS UTILITAIRES
// ============================

// Extraire le num√©ro du candidat depuis son ID (ex: '26miss1' -> '1')
function extractCandidateNumber(candidateId) {
  if (!candidateId) return '?';
  
  // Extraire les chiffres de l'ID
  const matches = candidateId.match(/\d+/g);
  if (matches && matches.length > 0) {
    // Prendre le dernier groupe de chiffres (pour g√©rer les IDs comme '26miss1')
    return matches[matches.length - 1];
  }
  
  // Si pas de chiffres, essayer de trouver le dernier chiffre
  const lastDigit = candidateId.match(/\d$/);
  if (lastDigit) return lastDigit[0];
  
  return '?';
}

// Fonction utilitaire pour les appels API
async function fetchAPI(endpoint, options = {}) {
  const controller = new AbortController();
  const timeoutId = setTimeout(() => controller.abort(), 10000);
  
  try {
    const response = await fetch(`${API_BASE_URL}${endpoint}`, {
      signal: controller.signal,
      headers: {
        'Content-Type': 'application/json',
        ...(adminToken && { 'Authorization': `Bearer ${adminToken}` }),
        ...options.headers
      },
      ...options
    });
    
    clearTimeout(timeoutId);
    
    if (!response.ok) {
      const errorText = await response.text();
      throw new Error(`Erreur ${response.status}: ${errorText}`);
    }
    
    return await response.json();
  } catch (error) {
    clearTimeout(timeoutId);
    if (error.name === 'AbortError') {
      throw new Error('Timeout: Le serveur ne r√©pond pas');
    }
    throw error;
  }
}

// Tester la connexion √† l'API
async function testConnection() {
  try {
    const data = await fetchAPI('/health');
    updateConnectionStatus(data.database === 'connected');
    return data.database === 'connected';
  } catch (error) {
    console.log('API non disponible:', error.message);
    updateConnectionStatus(false);
    return false;
  }
}

// Mettre √† jour le statut de connexion
function updateConnectionStatus(connected) {
  const badge = document.getElementById('status-badge');
  const warning = document.getElementById('connection-warning');
  
  isDatabaseConnected = connected;
  
  if (connected) {
    badge.className = 'status-badge';
    badge.textContent = '‚úì Connect√© BD';
    warning.style.display = 'none';
  } else {
    badge.className = 'status-badge offline';
    badge.textContent = '‚ö†Ô∏è Mode local';
    warning.style.display = 'block';
  }
}

// ============================
// CHARGEMENT DES DONN√âES
// ============================

// Charger les candidats
async function loadCandidates() {
  try {
    const isConnected = await testConnection();
    
    if (isConnected) {
      // Charger depuis l'API
      allCandidates = await fetchAPI('/candidates');
      console.log('Candidats charg√©s depuis API:', allCandidates);
    } else {
      // Charger depuis localStorage ou donn√©es par d√©faut
      const savedCandidates = localStorage.getItem('ahn_candidates');
      allCandidates = savedCandidates ? JSON.parse(savedCandidates) : [];
    }
    
    displayCandidates();
    
    // Charger stats et classement si connect√©
    if (isConnected) {
      await loadStats();
      await loadRanking();
    } else {
      updateTotalVotes();
      updateRanking();
    }
    
  } catch (error) {
    console.error('Erreur de chargement des candidats:', error);
    // Utiliser les donn√©es locales
    const savedCandidates = localStorage.getItem('ahn_candidates');
    allCandidates = savedCandidates ? JSON.parse(savedCandidates) : [];
    displayCandidates();
    updateTotalVotes();
    updateRanking();
  }
}

// Afficher les candidats
function displayCandidates() {
  // Filtrer par cat√©gorie
  const missCandidates = allCandidates.filter(c => c.categorie === 'miss');
  const misterCandidates = allCandidates.filter(c => c.categorie === 'mister');
  
  // Mettre √† jour le compteur
  document.getElementById('candidates-count').textContent = allCandidates.length;
  
  // Afficher les Miss avec leur num√©ro fixe
  const missList = document.getElementById('miss-list');
  missList.innerHTML = missCandidates.map(candidate => createCandidateCard(candidate)).join('');
  
  // Afficher les Mister avec leur num√©ro fixe
  const misterList = document.getElementById('mister-list');
  misterList.innerHTML = misterCandidates.map(candidate => createCandidateCard(candidate)).join('');
  
  // Ajouter les √©v√©nements aux boutons
  setTimeout(() => {
    document.querySelectorAll('.vote-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const candidateId = e.target.getAttribute('data-id');
        openPaymentModal(candidateId);
      });
    });
  }, 100);
}

// Cr√©er une carte candidat avec num√©ro fixe
function createCandidateCard(candidate) {
  const candidateNumber = candidate.candidate_number || extractCandidateNumber(candidate.id);
  const imageUrl = candidate.img 
    ? (candidate.img.startsWith('http') ? candidate.img : IMAGES_BASE_PATH + candidate.img)
    : null;
  
  const candidateName = candidate.nom || 'Candidat';
  const initials = candidateName.split(' ').map(word => word[0]).join('').toUpperCase().substring(0, 2);
  
  let imageContent = '';
  
  if (imageUrl) {
    imageContent = `
      <img src="${imageUrl}" alt="${candidateName}" 
           onerror="this.onerror=null; this.parentElement.innerHTML = \`
            <div style='width:100%;height:100%;background:linear-gradient(135deg,var(--accent-1),var(--accent-2));display:flex;align-items:center;justify-content:center;color:white;font-size:4rem;font-weight:bold;'>
              ${initials}
            </div>
          \`">
    `;
  } else {
    imageContent = `
      <div style="
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, var(--accent-1), var(--accent-2));
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 4rem;
        font-weight: bold;
      ">
        ${initials}
      </div>
    `;
  }
  
  return `
    <div class="candidate">
      <div class="candidate-number">${candidateNumber}</div>
      <div class="thumb">
        ${imageContent}
      </div>
      <div class="info">
        <h3>
          <span class="number-badge">Candidat N¬∞${candidateNumber}</span>
          ${candidateName}
        </h3>
        <div class="votes-badge" data-votes-id="${candidate.id}">Votes: ${candidate.votes || 0}</div>
      </div>
      <div class="actions">
        <button class="vote-btn" data-id="${candidate.id}">Voter</button>
      </div>
    </div>
  `;
}

// Charger les statistiques
async function loadStats() {
  try {
    const stats = await fetchAPI('/stats');
    document.getElementById('votes-count').textContent = stats.total_votes || 0;
  } catch (error) {
    console.log('Impossible de charger les stats:', error);
    updateTotalVotes();
  }
}

// Mettre √† jour le total des votes
function updateTotalVotes() {
  const totalVotes = allCandidates.reduce((sum, c) => sum + (c.votes || 0), 0);
  document.getElementById('votes-count').textContent = totalVotes;
}

// Charger le classement
async function loadRanking() {
  try {
    const ranking = await fetchAPI('/ranking');
    displayRanking(ranking);
  } catch (error) {
    console.log('Impossible de charger le classement:', error);
    updateRanking();
  }
}

// Mettre √† jour le classement
function updateRanking() {
  const ranking = [...allCandidates]
    .sort((a, b) => (b.votes || 0) - (a.votes || 0))
    .map((c, i) => ({
      ...c,
      rank_position: i + 1,
      candidate_number: c.candidate_number || extractCandidateNumber(c.id)
    }));
  displayRanking(ranking);
}

// Afficher le classement avec rang et num√©ro de candidat
function displayRanking(ranking) {
  const rankingDiv = document.getElementById('ranking');
  
  if (ranking.length > 0) {
    const maxVotes = Math.max(...ranking.map(c => c.votes || 0), 1);
    
    rankingDiv.innerHTML = ranking.map((c, i) => {
      const rank = c.rank_position || (i + 1);
      const candidateNumber = c.candidate_number || extractCandidateNumber(c.id);
      const percentage = ((c.votes || 0) / maxVotes) * 100;
      
      return `
        <div class="ranking-item">
          <div class="ranking-info">
            <span class="ranking-rank ${rank <= 3 ? 'rank-' + rank : ''}">${rank}</span>
            <span class="ranking-candidate-number">Candidat N¬∞${candidateNumber}</span>
            <strong>${c.nom}</strong>
            <span style="margin-left: auto; color: var(--accent-2); font-weight: bold;">
              ${c.votes || 0} vote(s)
            </span>
          </div>
          <div class="ranking-bar-container">
            <div class="ranking-bar" style="width: ${percentage}%"></div>
          </div>
        </div>
      `;
    }).join('');
  } else {
    rankingDiv.innerHTML = '<div class="loading">Aucun vote pour le moment</div>';
  }
}

// ============================
// GESTION DES VOTES
// ============================

// V√©rifier si un code de transaction existe d√©j√†
async function checkTransactionCode(code) {
  if (!code || !isDatabaseConnected) return { exists: false };
  
  try {
    const data = await fetchAPI(`/check-transaction/${encodeURIComponent(code)}`);
    return data;
  } catch (error) {
    console.log('Impossible de v√©rifier le code:', error);
    return { exists: false };
  }
}

// Modal de paiement
function openPaymentModal(candidateId) {
  currentCandidateId = candidateId;
  document.getElementById('vote-count').value = 1;
  document.getElementById('payment-code').value = '';
  document.getElementById('payment-amount').value = PRICE_PER_VOTE + ' FCFA';
  updatePaymentNumber();
  document.getElementById('payment-modal').style.display = 'flex';
}

function closePaymentModal() {
  document.getElementById('payment-modal').style.display = 'none';
  currentCandidateId = null;
}

// Calcul du montant
document.getElementById('vote-count').addEventListener('input', function() {
  let count = parseInt(this.value);
  if (count < 1) count = 1;
  this.value = count;
  document.getElementById('payment-amount').value = (count * PRICE_PER_VOTE) + " FCFA";
});

// Mettre √† jour le num√©ro de paiement
function updatePaymentNumber() {
  const method = document.getElementById('payment-method').value;
  let number = '';
  
  switch(method) {
    case 'orange_money':
      number = '#150*46*0761200#';
      break;
    case 'mtn_money':
      number = '#556#';
      break;
    case 'wave':
      number = '+221 78 123 45 67';
      break;
    default:
      number = '#150*46*0761200#';
  }
  
  document.getElementById('payment-number').textContent = 'Num√©ro ' + method.replace('_', ' ') + ' : ' + number;
}

document.getElementById('payment-method').addEventListener('change', updatePaymentNumber);

// Soumettre le paiement
document.getElementById('submit-payment').addEventListener('click', async function() {
  const method = document.getElementById('payment-method').value;
  const code = document.getElementById('payment-code').value.trim();
  const voteCount = parseInt(document.getElementById('vote-count').value) || 1;
  
  if (!code) {
    alert('Veuillez entrer le code de transaction re√ßu par SMS');
    return;
  }
  
  if (!currentCandidateId) {
    alert('Erreur: Candidat non s√©lectionn√©');
    return;
  }
  
  const candidate = allCandidates.find(c => c.id === currentCandidateId);
  if (!candidate) {
    alert('Erreur: Candidat introuvable');
    return;
  }
  
  // V√©rifier si le code existe d√©j√† (seulement si connect√©)
  if (isDatabaseConnected) {
    const checkResult = await checkTransactionCode(code);
    if (checkResult.exists) {
      const transaction = checkResult.transaction;
      alert(`‚ùå ERREUR : Ce code de transaction a d√©j√† √©t√© utilis√© !\n\n` +
            `Candidat: ${transaction.candidate_name || transaction.candidate_id}\n` +
            `Statut: ${transaction.statut}\n` +
            `Date: ${new Date(transaction.created_at).toLocaleString()}\n\n` +
            `Veuillez utiliser un code de transaction diff√©rent.`);
      return;
    }
  }
  
  // Pr√©parer les donn√©es du vote
  const voteData = {
    candidate_id: currentCandidateId,
    payment_method: method,
    transaction_code: code,
    vote_count: voteCount
  };
  
  if (isDatabaseConnected) {
    try {
      // Envoyer √† l'API
      const result = await fetchAPI('/vote', {
        method: 'POST',
        body: JSON.stringify(voteData)
      });
      
      closePaymentModal();
      alert('‚úÖ ' + result.message);
      
      // Recharger les donn√©es
      await loadCandidates();
      
    } catch (error) {
      console.error('Erreur lors de l\'envoi du vote:', error);
      
      // V√©rifier si c'est une erreur de code dupliqu√©
      if (error.message.includes('Code de transaction d√©j√† utilis√©') || 
          error.message.includes('409') ||
          error.message.includes('duplicate')) {
        alert('‚ùå ERREUR : Ce code de transaction a d√©j√† √©t√© utilis√© !\n\n' +
              'Veuillez utiliser un code de transaction diff√©rent.');
      } else {
        alert('‚ùå Erreur: ' + error.message + '\n\nVote enregistr√© localement.');
        saveVoteLocally(voteData, candidate);
      }
    }
  } else {
    // Mode hors ligne - v√©rifier localement si le code existe
    const existingLocal = pendingTransactions.find(t => t.transaction_code === code);
    if (existingLocal) {
      alert('‚ùå ERREUR : Ce code de transaction a d√©j√† √©t√© utilis√© localement !\n\n' +
            'Veuillez utiliser un code de transaction diff√©rent.');
      return;
    }
    
    // Mode hors ligne
    saveVoteLocally(voteData, candidate);
  }
});

// Sauvegarder un vote localement
function saveVoteLocally(voteData, candidate) {
  // V√©rifier si le code existe d√©j√† localement
  const existing = pendingTransactions.find(t => t.transaction_code === voteData.transaction_code);
  if (existing) {
    alert('‚ùå ERREUR : Ce code de transaction a d√©j√† √©t√© utilis√© localement !');
    return;
  }
  
  const transaction = {
    ...voteData,
    id: 'local_' + Date.now(),
    candidate_name: candidate.nom,
    created_at: new Date().toISOString(),
    statut: 'pending'
  };
  
  // Ajouter aux transactions locales
  pendingTransactions.push(transaction);
  
  // Mettre √† jour les votes localement
  candidate.votes = (candidate.votes || 0) + voteData.vote_count;
  
  // Mettre √† jour l'affichage
  const votesBadge = document.querySelector(`[data-votes-id="${candidate.id}"]`);
  if (votesBadge) {
    votesBadge.textContent = `Votes: ${candidate.votes}`;
    votesBadge.classList.add('animate');
    setTimeout(() => votesBadge.classList.remove('animate'), 600);
  }
  
  // Sauvegarder les donn√©es
  saveLocalData();
  
  // Mettre √† jour les compteurs et le classement
  updateTotalVotes();
  updateRanking();
  
  closePaymentModal();
  alert('‚úÖ Vote enregistr√© localement !\n\nIl sera synchronis√© lorsque la connexion sera r√©tablie.');
}

// ============================
// PANEL ADMIN
// ============================

// Ouvrir/fermer le panel admin
document.querySelector('.admin-btn').addEventListener('click', () => {
  document.getElementById('admin-panel').style.display = 'flex';
});

function closeAdminPanel() {
  document.getElementById('admin-panel').style.display = 'none';
  document.getElementById('admin-content').style.display = 'none';
  document.getElementById('admin-pass').value = '';
  adminToken = null;
}

// Connexion admin
document.getElementById('admin-login').addEventListener('click', async () => {
  const password = document.getElementById('admin-pass').value;
  
  if (!password) {
    alert('Veuillez entrer le mot de passe');
    return;
  }
  
  try {
    // Essayer de se connecter via l'API
    const result = await fetch(API_BASE_URL + '/admin/login', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({password: password})
    });
    
    if (result.ok) {
      const data = await result.json();
      adminToken = data.token;
      document.getElementById('admin-content').style.display = 'block';
      await refreshPendingTransactions();
    } else {
      const error = await result.json();
      alert('Erreur: ' + (error.error || 'Mot de passe incorrect'));
    }
  } catch (error) {
    console.error('Erreur de connexion admin:', error);
    
    // Si l'API √©choue, v√©rifier le mot de passe local
    if (password === '2025') {
      adminToken = 'local_token';
      document.getElementById('admin-content').style.display = 'block';
      refreshPendingTransactions();
    } else {
      alert('Mot de passe incorrect');
    }
  }
});

// Rafra√Æchir les transactions en attente
async function refreshPendingTransactions() {
  const section = document.getElementById('pending-list-section');
  section.innerHTML = '<div class="loading"><div class="loading-spinner"></div>Chargement...</div>';
  
  try {
    if (isDatabaseConnected && adminToken) {
      // Charger depuis l'API
      const transactions = await fetchAPI('/admin/transactions/pending');
      displayTransactions(transactions, true);
    } else {
      // Charger les transactions locales
      loadLocalTransactions();
      displayTransactions(pendingTransactions, false);
    }
  } catch (error) {
    console.error('Erreur lors du chargement des transactions:', error);
    section.innerHTML = `
      <div class="warning-box">
        ‚ùå Erreur de chargement: ${error.message}<br>
        <button onclick="refreshPendingTransactions()" style="margin-top:10px;padding:8px 16px;background:var(--accent-2);color:white;border:none;border-radius:8px;cursor:pointer;">
          R√©essayer
        </button>
      </div>
    `;
  }
}

// Afficher les transactions
function displayTransactions(transactions, fromAPI = true) {
  const section = document.getElementById('pending-list-section');
  
  if (transactions && transactions.length > 0) {
    section.innerHTML = transactions.map((t, index) => {
      const transactionId = fromAPI ? t.id : index;
      const apiCall = fromAPI ? 'validateAPITransaction' : 'validateLocalTransaction';
      const rejectCall = fromAPI ? 'rejectAPITransaction' : 'rejectLocalTransaction';
      
      const candidateNumber = t.candidate_number || extractCandidateNumber(t.candidate_id);
      
      return `
        <div class="admin-card">
          <div>
            <strong>Candidat N¬∞${candidateNumber}</strong><br>
            <strong>${t.candidate_name || t.nom || 'Candidat inconnu'}</strong><br>
            ${t.nombre_votes || t.vote_count || 1} vote(s) ‚Äî ${t.methode_paiement || t.payment_method || 'N/A'}<br>
            Code: <strong>${t.code_transaction || t.transaction_code || 'N/A'}</strong><br>
            <div class="admin-transaction-info">
              Montant: <span>${t.montant || ((t.nombre_votes || t.vote_count || 1) * PRICE_PER_VOTE)} FCFA</span><br>
              <small>${new Date(t.created_at).toLocaleString()}</small>
            </div>
          </div>
          <div>
            <button onclick="${apiCall}(${transactionId})">Valider</button>
            <button class="reject" onclick="${rejectCall}(${transactionId})">Rejeter</button>
          </div>
        </div>
      `;
    }).join('');
  } else {
    section.innerHTML = '<div class="loading">‚úÖ Aucune transaction en attente</div>';
  }
}

// Charger les transactions locales
function loadLocalTransactions() {
  try {
    const savedTransactions = localStorage.getItem('ahn_pending_transactions');
    if (savedTransactions) {
      pendingTransactions = JSON.parse(savedTransactions);
    }
  } catch (error) {
    console.log('Pas de transactions locales');
  }
}

// Valider une transaction API
async function validateAPITransaction(transactionId) {
  if (!confirm('Valider cette transaction ?')) return;
  
  try {
    await fetchAPI(`/admin/transactions/${transactionId}/validate`, {
      method: 'POST'
    });
    
    alert('‚úÖ Transaction valid√©e avec succ√®s !');
    await refreshPendingTransactions();
    await loadCandidates();
    
  } catch (error) {
    console.error('Erreur lors de la validation:', error);
    alert('‚ùå Erreur: ' + error.message);
  }
}

// Rejeter une transaction API
async function rejectAPITransaction(transactionId) {
  if (!confirm('Rejeter cette transaction ?')) return;
  
  try {
    await fetchAPI(`/admin/transactions/${transactionId}/reject`, {
      method: 'POST'
    });
    
    alert('‚úÖ Transaction rejet√©e avec succ√®s !');
    await refreshPendingTransactions();
    
  } catch (error) {
    console.error('Erreur lors du rejet:', error);
    alert('‚ùå Erreur: ' + error.message);
  }
}

// Valider une transaction locale
function validateLocalTransaction(index) {
  if (!confirm('Valider cette transaction locale ?')) return;
  
  const transaction = pendingTransactions[index];
  if (!transaction) return;
  
  // Les votes sont d√©j√† compt√©s localement, on supprime juste la transaction
  pendingTransactions.splice(index, 1);
  saveLocalData();
  refreshPendingTransactions();
  
  alert('‚úÖ Transaction valid√©e localement !');
}

// Rejeter une transaction locale
function rejectLocalTransaction(index) {
  if (!confirm('Rejeter cette transaction locale ?\nLes votes seront retir√©s.')) return;
  
  const transaction = pendingTransactions[index];
  if (!transaction) return;
  
  // Retirer les votes
  const candidate = allCandidates.find(c => c.id === transaction.candidate_id);
  if (candidate) {
    candidate.votes = Math.max(0, (candidate.votes || 0) - (transaction.vote_count || 1));
    
    // Mettre √† jour l'affichage
    const votesBadge = document.querySelector(`[data-votes-id="${candidate.id}"]`);
    if (votesBadge) {
      votesBadge.textContent = `Votes: ${candidate.votes}`;
    }
  }
  
  // Supprimer la transaction
  pendingTransactions.splice(index, 1);
  saveLocalData();
  refreshPendingTransactions();
  
  // Mettre √† jour les compteurs
  updateTotalVotes();
  updateRanking();
  
  alert('‚úÖ Transaction rejet√©e localement !');
}

// ============================
// GESTION DES DONN√âES LOCALES
// ============================

// Sauvegarder les donn√©es localement
function saveLocalData() {
  try {
    localStorage.setItem('ahn_candidates', JSON.stringify(allCandidates));
    localStorage.setItem('ahn_pending_transactions', JSON.stringify(pendingTransactions));
    localStorage.setItem('ahn_last_save', new Date().toISOString());
  } catch (error) {
    console.error('Erreur de sauvegarde locale:', error);
  }
}

// ============================
// INITIALISATION
// ============================

// Au chargement de la page
document.addEventListener('DOMContentLoaded', async () => {
  console.log('üöÄ D√©marrage de l\'application de vote...');
  
  // Charger les transactions locales
  loadLocalTransactions();
  
  // Tester la connexion et charger les donn√©es
  await loadCandidates();
  
  // V√©rifier p√©riodiquement la connexion
  setInterval(async () => {
    await testConnection();
  }, 30000);
});

// Synchroniser les votes locaux quand la connexion revient
window.addEventListener('online', async () => {
  console.log('Connexion r√©tablie, tentative de synchronisation...');
  const wasConnected = isDatabaseConnected;
  await testConnection();
  
  if (isDatabaseConnected && !wasConnected && pendingTransactions.length > 0) {
    if (confirm('Connexion r√©tablie ! Voulez-vous synchroniser les votes locaux ?')) {
      // Ici, vous pourriez ajouter une logique pour envoyer les votes locaux
      alert(`${pendingTransactions.length} votes √† synchroniser.`);
    }
  }
});
</script>
</body>
</html>
